{% extends "admin/base.html" %}

{% block title %}Crawler Instances{% endblock %}

{% block content %}
<div class="container">
    <div class="header">
        <h1>Pale Blue Search Admin</h1>
        <div class="nav">
            <a href="/admin/">Dashboard</a>
            <a href="/admin/crawlers" class="active">Crawlers</a>
            <a href="/admin/seeds">Seeds</a>
            <a href="/admin/queue">Queue</a>
            <a href="/admin/history">Crawl History</a>
            <a href="/admin/analytics">Analytics</a>
            <a href="/admin/logout">Logout</a>
        </div>
    </div>

    <div class="card">
        <h2>Crawler Instances</h2>
        <div class="table-scroll">
            <table class="admin-table admin-table--wide admin-table--dense">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>URL</th>
                        <th>Status</th>
                        <th class="admin-head-num" title="Concurrency">Conc.</th>
                        <th class="admin-head-num" title="Queue">Queue</th>
                        <th class="admin-head-num" title="Crawled">Crawled</th>
                        <th class="admin-head-num" title="Attempts/h">Att/h</th>
                        <th class="admin-head-num" title="Indexed/h">Idx/h</th>
                        <th class="admin-head-num" title="Success rate (last 1h)">OK%</th>
                        <th class="admin-head-num" title="Errors/h">Err/h</th>
                        <th class="admin-head-num" title="Uptime">Uptime</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for inst in instances %}
                    <tr>
                        <td>{{ inst.name }}</td>
                        <td class="admin-cell-url admin-cell-url--narrow admin-cell-url--clamp2 muted" title="{{ inst.url }}"><span class="admin-text-clamp2">{{ inst.url }}</span></td>
                        <td>
                            {% if inst.state == "running" %}
                                <span style="color: #22c55e; font-weight: bold;">● Running</span>
                            {% elif inst.state == "stopped" %}
                                <span style="color: #ef4444; font-weight: bold;">● Stopped</span>
                            {% else %}
                                <span style="color: #f59e0b;">● {{ inst.state }}</span>
                            {% endif %}
                        </td>
                        <td class="admin-cell-num">{{ inst.concurrency if inst.concurrency is not none else "-" }}</td>
                        <td class="admin-cell-num">{{ "{:,}".format(inst.queue_size) }}</td>
                        <td class="admin-cell-num">{{ "{:,}".format(inst.active_seen) }}</td>
                        <td class="admin-cell-num">{{ "{:,}".format(inst.attempts_1h) if inst.attempts_1h is not none else "-" }}</td>
                        <td class="admin-cell-num">{{ "{:,}".format(inst.indexed_1h) if inst.indexed_1h is not none else "-" }}</td>
                        <td class="admin-cell-num">{{ "{:.1f}%".format(inst.success_rate_1h) if inst.success_rate_1h is not none else "-" }}</td>
                        <td class="admin-cell-num">{{ "{:,}".format(inst.error_1h) if inst.error_1h is not none else "-" }}</td>
                        <td class="admin-cell-num">{{ inst.uptime or "-" }}</td>
                        <td>
                            {% if inst.state == "running" %}
                                <form action="/admin/crawlers/{{ inst.name }}/stop" method="post" style="display: inline;">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                    <button type="submit" class="danger" style="padding: 6px 12px; font-size: 0.9em;">Stop</button>
                                </form>
                            {% elif inst.state != "unreachable" %}
                                <form action="/admin/crawlers/{{ inst.name }}/start" method="post" class="admin-action-stack">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                    <input type="number" name="concurrency" value="1" min="1" max="10" style="width: 50px; padding: 6px; font-size: 0.9em;">
                                    <button type="submit" style="background-color: #22c55e; padding: 6px 12px; font-size: 0.9em;">Start</button>
                                </form>
                            {% else %}
                                <span style="color: #666;">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="card">
        <h2>Configuration</h2>
        <p style="color: #999; margin-bottom: 12px;">Configure crawler instances via environment variable:</p>
        <pre style="background: #1a1a2e; padding: 12px; border-radius: 6px; overflow-x: auto; font-size: 0.9em;">CRAWLER_INSTANCES="name1|http://host1:8000,name2|http://host2:8000"</pre>
    </div>
</div>
{% endblock %}
